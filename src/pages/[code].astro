---
import Layout from "../layouts/Layout.astro";
import { PropuestasService } from "../lib/supabase";
import "../styles/proposal-page.css";

// Generar rutas est√°ticas para propuestas existentes + fallback para nuevas
export async function getStaticPaths() {
    try {
        // Obtener todas las propuestas de la base de datos
        const propuestas = await PropuestasService.getAllProposals();
        
        // Generar rutas para propuestas existentes
        const staticRoutes = propuestas.map(propuesta => ({
            params: { code: propuesta.codigo_propuesta },
            props: { propuesta, isStatic: true }
        }));

        return staticRoutes;
    } catch (error) {
        console.error('Error generando rutas est√°ticas:', error);
        // Devolver arreglo vac√≠o si no hay propuestas
        return [];
    }
}

// Props de la p√°gina
const { propuesta, isStatic } = Astro.props;
const { code } = Astro.params;

// Si no hay propuesta est√°tica, ser√° cargada din√°micamente
const isDynamic = !propuesta;
---

<Layout title={propuesta ? `Propuesta - ${propuesta.nombre_proyecto}` : "Propuesta - Cloud Pixels"}>
    <!-- Loading state for dynamic proposals -->
    {isDynamic && (
        <div id="loading-state" class="loading-state">
            <p>Cargando propuesta...</p>
        </div>
        
        <div id="error-state" class="error-state" style="display: none;">
            <p>No se pudo cargar la propuesta. Verifica el c√≥digo proporcionado.</p>
        </div>
    )}
    
    <div id="proposal-content" style={isDynamic ? "display: none;" : ""}>
        <header>
            <nav>
                <div class="brand-logo">
                    <a href="#home">
                        <img src="Cloud Pixels.png" alt="Logo Cloud Pixels">
                    </a>
                </div>
                <ul>
                    <li><a href="#resumen">Resumen</a></li>
                    <li><a href="#sobre">Nosotros</a></li>
                    <li><a href="#servicios">Servicios</a></li>
                    <li><a href="#objetivos">Objetivos</a></li>
                    <li><a href="#entregables">Entregables</a></li>
                    <li><a href="#proceso">Proceso</a></li>
                    <li><a href="#propuesta">Propuesta Econ√≥mica</a></li>
                    <li><a href="#horarios">Horarios</a></li>
                    <li><a href="#terminos">T√©rminos</a></li>
                    <li><a href="#aceptacion">Aceptar</a></li>
                </ul>
            </nav>
        </header>

        <!-- Hero: informaci√≥n del proyecto -->
        <section class="hero" id="home">
            <h1 id="project-name">{propuesta?.nombre_proyecto || 'Proyecto'}</h1>
            
            <p id="client-info">
                <strong>Para:</strong> <span id="client-name">{propuesta?.cliente_nombre || 'Cliente'}</span> &nbsp;‚Äî&nbsp; <span id="client-company">{propuesta?.cliente_empresa || 'Empresa'}</span>
            </p>
            
            <p id="proposal-date">
                <strong>Fecha:</strong> <span id="proposal-date-text">{propuesta?.fecha_propuesta ? new Date(propuesta.fecha_propuesta).toLocaleDateString('es-ES') : 'DD/MM/AAAA'}</span>
            </p>
            
            <p class="hero-intro" id="hero-intro-text">
                {propuesta?.texto_introductorio || 'Soluciones creativas para impulsar tu presencia digital con dise√±o, desarrollo, branding y estrategias de marketing.'}
            </p>
            <a class="cta" href="#resumen">Explorar</a>
        </section>

        <!-- Resumen Ejecutivo -->
        <section class="section light" id="resumen">
            <h2 class="section-title">Resumen Ejecutivo</h2>
            <p id="executive-summary">
                {propuesta?.resumen_ejecutivo || 'Esta secci√≥n ofrece una visi√≥n general del proyecto y debe adaptarse a cada cliente. Describe brevemente los retos que enfrenta la empresa y c√≥mo tus servicios ayudar√°n a resolverlos.'}
            </p>
        </section>

        <!-- ¬øPor qu√© Cloud Pixels? -->
        <section class="section alt" id="sobre">
            <h2 class="section-title">¬øPor qu√© Cloud&nbsp;Pixels?</h2>
            <p id="company-description">
                {propuesta?.descripcion_empresa || 'Con m√°s de 9&nbsp;a√±os de experiencia, Cloud Pixels es un equipo global con oficinas en Honduras, Estados&nbsp;Unidos, Estonia y Panam√°. Combinamos talento de dise√±o y desarrollo de todo el mundo para crear soluciones digitales excepcionales y escalables.'}
            </p>
        </section>

        <!-- Servicios -->
        <section class="section light" id="servicios">
            <h2 class="section-title">Servicios</h2>
            <div class="services-grid" id="services-grid">
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('Website Design') && (
                    <div class="service-card">
                        <div class="icon">üñ•Ô∏è</div>
                        <h3>Website Design</h3>
                        <p>Dise√±o completo y responsive para tu sitio web, optimizado para conversi√≥n y experiencia de usuario.</p>
                    </div>
                )}
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('Landing Page') && (
                    <div class="service-card">
                        <div class="icon">üìÑ</div>
                        <h3>Landing Page</h3>
                        <p>P√°ginas de aterrizaje enfocadas en conversiones, integradas con campa√±as de marketing.</p>
                    </div>
                )}
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('Logo & Branding') && (
                    <div class="service-card">
                        <div class="icon">üé®</div>
                        <h3>Logo & Branding</h3>
                        <p>Desarrollo de identidad visual, logos e imagen corporativa para fortalecer tu marca.</p>
                    </div>
                )}
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('Email Marketing') && (
                    <div class="service-card">
                        <div class="icon">‚úâÔ∏è</div>
                        <h3>Email Marketing</h3>
                        <p>Dise√±o y automatizaci√≥n de campa√±as de email marketing efectivas.</p>
                    </div>
                )}
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('SEO Review & Consulting') && (
                    <div class="service-card">
                        <div class="icon">üîç</div>
                        <h3>SEO Review & Consulting</h3>
                        <p>An√°lisis SEO detallado y recomendaciones para mejorar tu posicionamiento en buscadores.</p>
                    </div>
                )}
                {propuesta?.servicios_seleccionados && Array.isArray(propuesta.servicios_seleccionados) && propuesta.servicios_seleccionados.includes('Ecommerce Site') && (
                    <div class="service-card">
                        <div class="icon">üõí</div>
                        <h3>Ecommerce Site</h3>
                        <p>Desarrollo e integraci√≥n de tiendas en l√≠nea con pasarelas de pago y gesti√≥n de productos.</p>
                    </div>
                )}
                {(!propuesta?.servicios_seleccionados || !Array.isArray(propuesta.servicios_seleccionados) || propuesta.servicios_seleccionados.length === 0) && (
                    <>
                        <div class="service-card">
                            <div class="icon">üñ•Ô∏è</div>
                            <h3>Website Design</h3>
                            <p>Dise√±o completo y responsive para tu sitio web, optimizado para conversi√≥n y experiencia de usuario.</p>
                        </div>
                        <div class="service-card">
                            <div class="icon">üìÑ</div>
                            <h3>Landing Page</h3>
                            <p>P√°ginas de aterrizaje enfocadas en conversiones, integradas con campa√±as de marketing.</p>
                        </div>
                        <div class="service-card">
                            <div class="icon">üé®</div>
                            <h3>Logo & Branding</h3>
                            <p>Desarrollo de identidad visual, logos e imagen corporativa para fortalecer tu marca.</p>
                        </div>
                    </>
                )}
            </div>
        </section>

        <!-- Objetivos y alcance -->
        <section class="section alt" id="objetivos">
            <h2 class="section-title">Objetivos &amp; Alcance</h2>
            <p id="objectives-scope">
                {propuesta?.objetivos_alcance || 'Describe en esta secci√≥n los objetivos espec√≠ficos del proyecto y el alcance del trabajo. Por ejemplo, puedes mencionar la mejora de la presencia digital, el aumento de conversiones o la expansi√≥n del alcance de la marca.'}
            </p>
        </section>

        <!-- Entregables -->
        <section class="section light" id="entregables">
            <h2 class="section-title">Entregables</h2>
            <ul class="deliverables-list" id="deliverables-list">
                {propuesta?.entregables && Array.isArray(propuesta.entregables) ? 
                    propuesta.entregables.map((entregable: string) => <li>{entregable}</li>) :
                    // Entregables por defecto
                    <>
                        <li>Dise√±o UI/UX completo para desktop y mobile</li>
                        <li>Desarrollo del sitio web e integraciones necesarias</li>
                        <li>Integraci√≥n de ecommerce y pasarela de pago</li>
                        <li>Manual de marca y activos visuales</li>
                        <li>Capacitaci√≥n en video de 30&nbsp;minutos para el equipo</li>
                    </>
                }
            </ul>
        </section>

        <!-- Proceso & Timeline -->
        <section class="section alt" id="proceso">
            <h2 class="section-title">Proceso &amp; Timeline</h2>
            <div class="timeline" id="process-timeline">
                {propuesta?.proceso_timeline && Array.isArray(propuesta.proceso_timeline) ? 
                    propuesta.proceso_timeline.map((fase: { title: string; duration: string; description: string }) => (
                        <div class="timeline-item">
                            <div class="circle"></div>
                            <h4>{fase.title}<br><small>({fase.duration})</small></h4>
                            <p>{fase.description}</p>
                        </div>
                    )) :
                    // Timeline por defecto
                    <>
                        <div class="timeline-item">
                            <div class="circle"></div>
                            <h4>Fase&nbsp;1: Brief &amp; Investigaci√≥n<br><small>(1 semana)</small></h4>
                            <p>Recolecci√≥n de requisitos, an√°lisis de mercado y definici√≥n del alcance del proyecto.</p>
                        </div>
                        <div class="timeline-item">
                            <div class="circle"></div>
                            <h4>Fase&nbsp;2: Dise√±o UI/UX<br><small>(1‚Äë2 semanas)</small></h4>
                            <p>Creaci√≥n de wireframes y prototipos visuales, iteraciones seg√∫n tu feedback.</p>
                        </div>
                        <div class="timeline-item">
                            <div class="circle"></div>
                            <h4>Fase&nbsp;3: Desarrollo &amp; Integraciones<br><small>(2‚Äë3 semanas)</small></h4>
                            <p>Implementaci√≥n t√©cnica del sitio, carga de contenido y configuraciones.</p>
                        </div>
                        <div class="timeline-item">
                            <div class="circle"></div>
                            <h4>Fase&nbsp;4: Pruebas &amp; Lanzamiento<br><small>(1 semana)</small></h4>
                            <p>Revisi√≥n final, pruebas de calidad y puesta en l√≠nea del proyecto.</p>
                        </div>
                    </>
                }
            </div>
        </section>

        <!-- Propuesta econ√≥mica -->
        <section class="section light" id="propuesta">
            <h2 class="section-title">Propuesta Econ√≥mica</h2>
            <p>La inversi√≥n total para este proyecto es:</p>
            <div class="pricing-grid">
                <div class="pricing-card featured">
                    <h3>Valor del Proyecto</h3>
                    <div class="price" id="project-price">{propuesta?.valor_proyecto || '$X,XXX'}</div>
                    <ul id="payment-terms">
                        {propuesta?.terminos_pago ? 
                            propuesta.terminos_pago.split('\n').map((termino: string) => <li>{termino}</li>) :
                            <>
                                <li>Incluye todos los servicios y entregables definidos en esta propuesta</li>
                                <li>Pago inicial del 50% al aceptar la propuesta</li>
                                <li>Saldo restante al finalizar el proyecto</li>
                            </>
                        }
                    </ul>
                </div>
            </div>
        </section>

        <!-- Horarios de atenci√≥n y canales de comunicaci√≥n -->
        <section class="section alt" id="horarios">
            <h2 class="section-title">Horarios de Atenci√≥n &amp; Canales de Comunicaci√≥n</h2>
            <p id="business-hours">
                {propuesta?.horarios_atencion || 'Nuestro equipo est√° disponible de lunes a viernes de 9:00&nbsp;a.m. a 6:00&nbsp;p.m. (aplican d√≠as feriados). Para consultas fuera de este horario, responderemos al siguiente d√≠a laboral.'}
            </p>
            <p>Nos puedes contactar a trav√©s de los siguientes canales:</p>
            <ul class="contact-list" id="contact-info">
                <li><strong>Email:</strong> <span id="contact-email">{propuesta?.contacto_email || 'tu.correo@cloudpixels.com'}</span></li>
                <li><strong>WhatsApp:</strong> <span id="contact-whatsapp">{propuesta?.contacto_whatsapp || '+XX&nbsp;XXX&nbsp;XXX&nbsp;XXXX'}</span></li>
            </ul>
        </section>

        <!-- T√©rminos y condiciones -->
        <section class="section light" id="terminos">
            <h2 class="section-title">T√©rminos &amp; Condiciones</h2>
            <div class="terms">
                <p id="terms-conditions">
                    {propuesta?.terminos_condiciones || 'Al aceptar esta propuesta, el cliente se compromete a abonar un anticipo del 50% para iniciar el proyecto. El saldo restante se pagar√° al finalizar, antes del lanzamiento.'}
                </p>
                <p id="terms-validity">
                    {propuesta?.terminos_validez || 'Esta propuesta es v√°lida durante 30&nbsp;d√≠as a partir de la fecha de emisi√≥n. Los servicios de mantenimiento, hosting o funcionalidades adicionales no mencionados aqu√≠ se considerar√°n extras opcionales.'}
                </p>
            </div>
        </section>

        <!-- Aceptaci√≥n y pr√≥ximos pasos -->
        <section class="section alt accept-section" id="aceptacion">
            <h2 class="section-title">Aceptaci√≥n &amp; Pr√≥ximos Pasos</h2>
            <p id="acceptance-text">
                {propuesta?.texto_aceptacion || '¬øListo para comenzar? Haz clic en el bot√≥n de abajo para aceptar la propuesta. Podr√°s firmar digitalmente y realizar el pago inicial.'}
            </p>
            <a class="cta-accept" href="#">Aceptar Propuesta</a>
        </section>

        <!-- Footer -->
        <footer>
            <p>¬© 2025 Cloud Pixels. Todos los derechos reservados.</p>
        </footer>
    </div>

    <script define:vars={{ isDynamic, code }}>
        // Para propuestas din√°micas (no pre-generadas)
        if (isDynamic) {
            async function loadDynamicProposal() {
                try {
                    // Import Supabase service directly for client-side loading
                    const { PropuestasService } = await import('../lib/supabase.js');
                    
                    // Initialize and get proposal by code
                    const propuesta = await PropuestasService.getProposalByCode(code);
                    
                    if (!propuesta) {
                        throw new Error('Propuesta no encontrada');
                    }
                    populateProposal(propuesta);
                    
                    // Mostrar contenido
                    document.getElementById('loading-state').style.display = 'none';
                    document.getElementById('proposal-content').style.display = 'block';
                    
                    // Actualizar t√≠tulo
                    document.title = `Propuesta - ${propuesta.nombre_proyecto}`;
                    
                } catch (error) {
                    console.error('Error cargando propuesta:', error);
                    document.getElementById('loading-state').style.display = 'none';
                    document.getElementById('error-state').style.display = 'block';
                }
            }

            function populateProposal(propuesta) {
                // Hero section
                document.getElementById('project-name').textContent = propuesta.nombre_proyecto || 'Proyecto';
                document.getElementById('client-name').textContent = propuesta.cliente_nombre || 'Cliente';
                document.getElementById('client-company').textContent = propuesta.cliente_empresa || 'Empresa';
                document.getElementById('proposal-date-text').textContent = 
                    propuesta.fecha_propuesta ? new Date(propuesta.fecha_propuesta).toLocaleDateString('es-ES') : 'DD/MM/AAAA';
                
                if (propuesta.texto_introductorio) {
                    document.getElementById('hero-intro-text').textContent = propuesta.texto_introductorio;
                }

                // Content sections
                if (propuesta.resumen_ejecutivo) {
                    document.getElementById('executive-summary').textContent = propuesta.resumen_ejecutivo;
                }
                
                if (propuesta.descripcion_empresa) {
                    document.getElementById('company-description').textContent = propuesta.descripcion_empresa;
                }
                
                if (propuesta.objetivos_alcance) {
                    document.getElementById('objectives-scope').textContent = propuesta.objetivos_alcance;
                }

                // Services
                populateServices(propuesta.servicios_seleccionados);
                
                // Deliverables
                populateDeliverables(propuesta.entregables);
                
                // Timeline
                populateTimeline(propuesta.proceso_timeline);
                
                // Pricing
                document.getElementById('project-price').textContent = propuesta.valor_proyecto || '$X,XXX';
                populatePaymentTerms(propuesta.terminos_pago);
                
                // Contact info
                if (propuesta.horarios_atencion) {
                    document.getElementById('business-hours').textContent = propuesta.horarios_atencion;
                }
                
                if (propuesta.contacto_email) {
                    document.getElementById('contact-email').textContent = propuesta.contacto_email;
                }
                
                if (propuesta.contacto_whatsapp) {
                    document.getElementById('contact-whatsapp').textContent = propuesta.contacto_whatsapp;
                }

                // Terms
                if (propuesta.terminos_condiciones) {
                    document.getElementById('terms-conditions').textContent = propuesta.terminos_condiciones;
                }
                
                if (propuesta.terminos_validez) {
                    document.getElementById('terms-validity').textContent = propuesta.terminos_validez;
                }
                
                if (propuesta.texto_aceptacion) {
                    document.getElementById('acceptance-text').textContent = propuesta.texto_aceptacion;
                }
            }

            // Auxiliary functions
            function populateServices(servicios) {
                const servicesGrid = document.getElementById('services-grid');
                servicesGrid.innerHTML = '';

                const serviceTemplates = {
                    'Website Design': { icon: 'üñ•Ô∏è', title: 'Website Design', description: 'Dise√±o completo y responsive para tu sitio web, optimizado para conversi√≥n y experiencia de usuario.' },
                    'Landing Page': { icon: 'üìÑ', title: 'Landing Page', description: 'P√°ginas de aterrizaje enfocadas en conversiones, integradas con campa√±as de marketing.' },
                    'Logo & Branding': { icon: 'üé®', title: 'Logo & Branding', description: 'Desarrollo de identidad visual, logos e imagen corporativa para fortalecer tu marca.' },
                    'Email Marketing': { icon: '‚úâÔ∏è', title: 'Email Marketing', description: 'Dise√±o y automatizaci√≥n de campa√±as de email marketing efectivas.' },
                    'SEO Review & Consulting': { icon: 'üîç', title: 'SEO Review & Consulting', description: 'An√°lisis SEO detallado y recomendaciones para mejorar tu posicionamiento en buscadores.' },
                    'Ecommerce Site': { icon: 'üõí', title: 'Ecommerce Site', description: 'Desarrollo e integraci√≥n de tiendas en l√≠nea con pasarelas de pago y gesti√≥n de productos.' }
                };

                const serviciosSeleccionados = servicios && Array.isArray(servicios) ? servicios : ['Website Design', 'Landing Page', 'Logo & Branding'];

                serviciosSeleccionados.forEach(servicio => {
                    const template = serviceTemplates[servicio];
                    if (template) {
                        const serviceCard = document.createElement('div');
                        serviceCard.className = 'service-card';
                        serviceCard.innerHTML = `
                            <div class="icon">${template.icon}</div>
                            <h3>${template.title}</h3>
                            <p>${template.description}</p>
                        `;
                        servicesGrid.appendChild(serviceCard);
                    }
                });
            }

            function populateDeliverables(entregables) {
                const deliverablesList = document.getElementById('deliverables-list');
                deliverablesList.innerHTML = '';

                const items = entregables && Array.isArray(entregables) ? entregables : [
                    'Dise√±o UI/UX completo para desktop y mobile',
                    'Desarrollo del sitio web e integraciones necesarias',
                    'Integraci√≥n de ecommerce y pasarela de pago',
                    'Manual de marca y activos visuales',
                    'Capacitaci√≥n en video de 30 minutos para el equipo'
                ];

                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    deliverablesList.appendChild(li);
                });
            }

            function populateTimeline(timeline) {
                const timelineContainer = document.getElementById('process-timeline');
                timelineContainer.innerHTML = '';

                const fases = timeline && Array.isArray(timeline) ? timeline : [
                    { title: 'Fase 1: Brief & Investigaci√≥n', duration: '1 semana', description: 'Recolecci√≥n de requisitos, an√°lisis de mercado y definici√≥n del alcance del proyecto.' },
                    { title: 'Fase 2: Dise√±o UI/UX', duration: '1‚Äë2 semanas', description: 'Creaci√≥n de wireframes y prototipos visuales, iteraciones seg√∫n tu feedback.' },
                    { title: 'Fase 3: Desarrollo & Integraciones', duration: '2‚Äë3 semanas', description: 'Implementaci√≥n t√©cnica del sitio, carga de contenido y configuraciones.' },
                    { title: 'Fase 4: Pruebas & Lanzamiento', duration: '1 semana', description: 'Revisi√≥n final, pruebas de calidad y puesta en l√≠nea del proyecto.' }
                ];

                fases.forEach(fase => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = 'timeline-item';
                    timelineItem.innerHTML = `
                        <div class="circle"></div>
                        <h4>${fase.title}<br><small>(${fase.duration})</small></h4>
                        <p>${fase.description}</p>
                    `;
                    timelineContainer.appendChild(timelineItem);
                });
            }

            function populatePaymentTerms(terminos) {
                const paymentTermsList = document.getElementById('payment-terms');
                paymentTermsList.innerHTML = '';

                const terms = terminos ? terminos.split('\n') : [
                    'Incluye todos los servicios y entregables definidos en esta propuesta',
                    'Pago inicial del 50% al aceptar la propuesta',
                    'Saldo restante al finalizar el proyecto'
                ];

                terms.forEach(term => {
                    const li = document.createElement('li');
                    li.textContent = term;
                    paymentTermsList.appendChild(li);
                });
            }

            // Load dynamic proposal on page load
            document.addEventListener('DOMContentLoaded', loadDynamicProposal);
        }

        // Navigation functionality (for both static and dynamic)
        function updateActiveNav() {
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('header nav ul li a');
            
            let current = '';
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (window.pageYOffset >= (sectionTop - 200)) {
                    current = section.getAttribute('id') || '';
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }
        
        // Setup navigation
        document.addEventListener('DOMContentLoaded', updateActiveNav);
        window.addEventListener('scroll', updateActiveNav);
        
        document.querySelectorAll('header nav ul li a').forEach(link => {
            link.addEventListener('click', function(e) {
                document.querySelectorAll('header nav ul li a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>

    <style>
        .loading-state, .error-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
            text-align: center;
        }

        .loading-state p, .error-state p {
            font-size: 1.2em;
            color: #666;
        }
    </style>
</Layout>