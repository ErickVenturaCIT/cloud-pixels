---
import Layout from "../layouts/Layout.astro";
import "../styles/proposal-page.css";
---

<Layout title="Detalles de Propuesta - Cloud Pixels">
    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Cargando propuesta...</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="error-state" style="display: none;">
        <div class="error-content">
            <h2>‚ùå Propuesta no encontrada</h2>
            <p>No se pudo encontrar la propuesta con el c√≥digo especificado.</p>
            <div class="error-actions">
                <a href="/admin" class="btn btn-primary">üè† Volver al Admin</a>
                <a href="/" class="btn btn-secondary">üè† Ir al Inicio</a>
            </div>
        </div>
    </div>

    <!-- Proposal content -->
    <div id="proposal-content" style="display: none;">
        <header>
            <nav>
                <div class="brand-logo">
                    <a href="#home">
                        <img src="Cloud Pixels.png" alt="Logo Cloud Pixels">
                    </a>
                </div>
                <ul>
                    <li><a href="#resumen">Resumen</a></li>
                    <li><a href="#sobre">Nosotros</a></li>
                    <li><a href="#servicios">Servicios</a></li>
                    <li><a href="#objetivos">Objetivos</a></li>
                    <li><a href="#entregables">Entregables</a></li>
                    <li><a href="#proceso">Proceso</a></li>
                    <li><a href="#propuesta">Propuesta Econ√≥mica</a></li>
                    <li><a href="#horarios">Horarios</a></li>
                    <li><a href="#terminos">T√©rminos</a></li>
                    <li><a href="#aceptacion">Aceptar</a></li>
                </ul>
            </nav>
        </header>

        <!-- Hero: informaci√≥n del proyecto -->
        <section class="hero" id="home">
            <h1 id="project-name">Cargando...</h1>
            
            <p id="client-info">
                <strong>Para:</strong> <span id="client-name">Cargando...</span> ‚Äî <span id="client-company">Cargando...</span>
            </p>
            
            <p id="proposal-date">
                <strong>Fecha:</strong> <span id="proposal-date-text">Cargando...</span>
            </p>
            
            <p class="hero-intro" id="hero-intro-text">
                Soluciones creativas para impulsar tu presencia digital con dise√±o, desarrollo, branding y estrategias de marketing.
            </p>
            <a class="cta" href="#resumen">Explorar</a>
        </section>

        <!-- Resumen Ejecutivo -->
        <section class="section light" id="resumen">
            <h2 class="section-title">Resumen Ejecutivo</h2>
            <p id="executive-summary">
                Cargando resumen ejecutivo...
            </p>
        </section>

        <!-- ¬øPor qu√© Cloud Pixels? -->
        <section class="section alt" id="sobre">
            <h2 class="section-title">¬øPor qu√© Cloud&nbsp;Pixels?</h2>
            <p id="company-description">
                Cargando descripci√≥n de la empresa...
            </p>
        </section>

        <!-- Servicios -->
        <section class="section light" id="servicios">
            <h2 class="section-title">Servicios</h2>
            <div class="services-grid" id="services-grid">
                <!-- Services will be populated by JavaScript -->
            </div>
        </section>

        <!-- Objetivos y alcance -->
        <section class="section alt" id="objetivos">
            <h2 class="section-title">Objetivos &amp; Alcance</h2>
            <p id="objectives-scope">
                Cargando objetivos y alcance...
            </p>
        </section>

        <!-- Entregables -->
        <section class="section light" id="entregables">
            <h2 class="section-title">Entregables</h2>
            <ul class="deliverables-list" id="deliverables-list">
                <!-- Deliverables will be populated by JavaScript -->
            </ul>
        </section>

        <!-- Proceso & Timeline -->
        <section class="section alt" id="proceso">
            <h2 class="section-title">Proceso &amp; Timeline</h2>
            <div class="timeline" id="process-timeline">
                <!-- Timeline will be populated by JavaScript -->
            </div>
        </section>

        <!-- Propuesta econ√≥mica -->
        <section class="section light" id="propuesta">
            <h2 class="section-title">Propuesta Econ√≥mica</h2>
            <p>La inversi√≥n total para este proyecto es:</p>
            <div class="pricing-grid">
                <div class="pricing-card featured">
                    <h3>Valor del Proyecto</h3>
                    <div class="price" id="project-price">Cargando...</div>
                    <ul id="payment-terms">
                        <!-- Payment terms will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- Horarios de atenci√≥n y canales de comunicaci√≥n -->
        <section class="section alt" id="horarios">
            <h2 class="section-title">Horarios de Atenci√≥n &amp; Canales de Comunicaci√≥n</h2>
            <p id="business-hours">
                Cargando horarios de atenci√≥n...
            </p>
            <p>Nos puedes contactar a trav√©s de los siguientes canales:</p>
            <ul class="contact-list" id="contact-info">
                <li><strong>Email:</strong> <span id="contact-email">Cargando...</span></li>
                <li><strong>WhatsApp:</strong> <span id="contact-whatsapp">Cargando...</span></li>
            </ul>
        </section>

        <!-- T√©rminos y condiciones -->
        <section class="section light" id="terminos">
            <h2 class="section-title">T√©rminos &amp; Condiciones</h2>
            <div class="terms">
                <p id="terms-conditions">
                    Cargando t√©rminos y condiciones...
                </p>
                <p id="terms-validity">
                    Cargando t√©rminos de validez...
                </p>
            </div>
        </section>

        <!-- Aceptaci√≥n y pr√≥ximos pasos -->
        <section class="section alt accept-section" id="aceptacion">
            <h2 class="section-title">Aceptaci√≥n &amp; Pr√≥ximos Pasos</h2>
            <p id="acceptance-text">
                Cargando texto de aceptaci√≥n...
            </p>
            <a class="cta-accept" href="#">Aceptar Propuesta</a>
        </section>

        <!-- Footer -->
        <footer>
            <p>¬© 2025 Cloud Pixels. Todos los derechos reservados.</p>
        </footer>
    </div>

    <script>
        // Funci√≥n para obtener par√°metros de URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Funci√≥n para cargar datos de la propuesta
        async function loadProposal(code) {
            try {
                // Verificar que el servicio est√© disponible
                if (!window.PropuestasService) {
                    throw new Error('Servicio de propuestas no disponible');
                }

                const propuesta = await window.PropuestasService.getProposalByCode(code);
                
                if (!propuesta) {
                    throw new Error('Propuesta no encontrada');
                }

                populateProposal(propuesta);
                
                // Ocultar loading y mostrar contenido
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('proposal-content').style.display = 'block';
                
                // Actualizar t√≠tulo
                document.title = `Propuesta - ${propuesta.nombre_proyecto}`;
                
            } catch (error) {
                console.error('Error cargando propuesta:', error);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
            }
        }

        // Funci√≥n para poblar el contenido de la propuesta
        function populateProposal(propuesta) {
            // Hero section
            document.getElementById('project-name').textContent = propuesta.nombre_proyecto || 'Proyecto';
            document.getElementById('client-name').textContent = propuesta.cliente_nombre || 'Cliente';
            document.getElementById('client-company').textContent = propuesta.cliente_empresa || 'Empresa';
            document.getElementById('proposal-date-text').textContent = 
                propuesta.fecha_propuesta ? new Date(propuesta.fecha_propuesta).toLocaleDateString('es-ES') : 'DD/MM/AAAA';
            
            if (propuesta.texto_introductorio) {
                document.getElementById('hero-intro-text').textContent = propuesta.texto_introductorio;
            }

            // Content sections
            if (propuesta.resumen_ejecutivo) {
                document.getElementById('executive-summary').textContent = propuesta.resumen_ejecutivo;
            }
            
            if (propuesta.descripcion_empresa) {
                document.getElementById('company-description').textContent = propuesta.descripcion_empresa;
            }
            
            if (propuesta.objetivos_alcance) {
                document.getElementById('objectives-scope').textContent = propuesta.objetivos_alcance;
            }

            // Services
            populateServices(propuesta.servicios_seleccionados);
            
            // Deliverables
            populateDeliverables(propuesta.entregables);
            
            // Timeline
            populateTimeline(propuesta.proceso_timeline);
            
            // Pricing
            document.getElementById('project-price').textContent = propuesta.valor_proyecto || '$X,XXX';
            populatePaymentTerms(propuesta.terminos_pago);
            
            // Contact info
            if (propuesta.horarios_atencion) {
                document.getElementById('business-hours').textContent = propuesta.horarios_atencion;
            }
            
            if (propuesta.contacto_email) {
                document.getElementById('contact-email').textContent = propuesta.contacto_email;
            }
            
            if (propuesta.contacto_whatsapp) {
                document.getElementById('contact-whatsapp').textContent = propuesta.contacto_whatsapp;
            }

            // Terms
            if (propuesta.terminos_condiciones) {
                document.getElementById('terms-conditions').textContent = propuesta.terminos_condiciones;
            }
            
            if (propuesta.terminos_validez) {
                document.getElementById('terms-validity').textContent = propuesta.terminos_validez;
            }
            
            if (propuesta.texto_aceptacion) {
                document.getElementById('acceptance-text').textContent = propuesta.texto_aceptacion;
            }
        }

        // Funciones auxiliares para poblar secciones espec√≠ficas
        function populateServices(servicios) {
            const servicesGrid = document.getElementById('services-grid');
            servicesGrid.innerHTML = '';

            const serviceTemplates = {
                'Website Design': {
                    icon: 'üñ•Ô∏è',
                    title: 'Website Design',
                    description: 'Dise√±o completo y responsive para tu sitio web, optimizado para conversi√≥n y experiencia de usuario.'
                },
                'Landing Page': {
                    icon: 'üìÑ',
                    title: 'Landing Page',
                    description: 'P√°ginas de aterrizaje enfocadas en conversiones, integradas con campa√±as de marketing.'
                },
                'Logo & Branding': {
                    icon: 'üé®',
                    title: 'Logo & Branding',
                    description: 'Desarrollo de identidad visual, logos e imagen corporativa para fortalecer tu marca.'
                },
                'Email Marketing': {
                    icon: '‚úâÔ∏è',
                    title: 'Email Marketing',
                    description: 'Dise√±o y automatizaci√≥n de campa√±as de email marketing efectivas.'
                },
                'SEO Review & Consulting': {
                    icon: 'üîç',
                    title: 'SEO Review & Consulting',
                    description: 'An√°lisis SEO detallado y recomendaciones para mejorar tu posicionamiento en buscadores.'
                },
                'Ecommerce Site': {
                    icon: 'üõí',
                    title: 'Ecommerce Site',
                    description: 'Desarrollo e integraci√≥n de tiendas en l√≠nea con pasarelas de pago y gesti√≥n de productos.'
                }
            };

            const serviciosSeleccionados = servicios && Array.isArray(servicios) ? servicios : ['Website Design', 'Landing Page', 'Logo & Branding'];

            serviciosSeleccionados.forEach(servicio => {
                const template = serviceTemplates[servicio];
                if (template) {
                    const serviceCard = document.createElement('div');
                    serviceCard.className = 'service-card';
                    serviceCard.innerHTML = `
                        <div class="icon">${template.icon}</div>
                        <h3>${template.title}</h3>
                        <p>${template.description}</p>
                    `;
                    servicesGrid.appendChild(serviceCard);
                }
            });
        }

        function populateDeliverables(entregables) {
            const deliverablesList = document.getElementById('deliverables-list');
            deliverablesList.innerHTML = '';

            const items = entregables && Array.isArray(entregables) ? entregables : [
                'Dise√±o UI/UX completo para desktop y mobile',
                'Desarrollo del sitio web e integraciones necesarias',
                'Integraci√≥n de ecommerce y pasarela de pago',
                'Manual de marca y activos visuales',
                'Capacitaci√≥n en video de 30&nbsp;minutos para el equipo'
            ];

            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                deliverablesList.appendChild(li);
            });
        }

        function populateTimeline(timeline) {
            const timelineContainer = document.getElementById('process-timeline');
            timelineContainer.innerHTML = '';

            const fases = timeline && Array.isArray(timeline) ? timeline : [
                { title: 'Fase 1: Brief & Investigaci√≥n', duration: '1 semana', description: 'Recolecci√≥n de requisitos, an√°lisis de mercado y definici√≥n del alcance del proyecto.' },
                { title: 'Fase 2: Dise√±o UI/UX', duration: '1‚Äë2 semanas', description: 'Creaci√≥n de wireframes y prototipos visuales, iteraciones seg√∫n tu feedback.' },
                { title: 'Fase 3: Desarrollo & Integraciones', duration: '2‚Äë3 semanas', description: 'Implementaci√≥n t√©cnica del sitio, carga de contenido y configuraciones.' },
                { title: 'Fase 4: Pruebas & Lanzamiento', duration: '1 semana', description: 'Revisi√≥n final, pruebas de calidad y puesta en l√≠nea del proyecto.' }
            ];

            fases.forEach(fase => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                timelineItem.innerHTML = `
                    <div class="circle"></div>
                    <h4>${fase.title}<br><small>(${fase.duration})</small></h4>
                    <p>${fase.description}</p>
                `;
                timelineContainer.appendChild(timelineItem);
            });
        }

        function populatePaymentTerms(terminos) {
            const paymentTermsList = document.getElementById('payment-terms');
            paymentTermsList.innerHTML = '';

            const terms = terminos ? terminos.split('\n') : [
                'Incluye todos los servicios y entregables definidos en esta propuesta',
                'Pago inicial del 50% al aceptar la propuesta',
                'Saldo restante al finalizar el proyecto'
            ];

            terms.forEach(term => {
                const li = document.createElement('li');
                li.textContent = term;
                paymentTermsList.appendChild(li);
            });
        }

        // Funci√≥n para actualizar la navegaci√≥n activa
        function updateActiveNav() {
            const sections = document.querySelectorAll('section[id]');
            const navLinks = document.querySelectorAll('header nav ul li a');
            
            let current = '';
            
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.clientHeight;
                if (window.pageYOffset >= (sectionTop - 200)) {
                    current = section.getAttribute('id') || '';
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }
        
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const code = getUrlParameter('code');
            
            if (code) {
                loadProposal(code);
            } else {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.querySelector('#error-state .error-content h2').textContent = '‚ùå C√≥digo no especificado';
                document.querySelector('#error-state .error-content p').textContent = 'No se especific√≥ c√≥digo de propuesta. Usa ?code=CODIGO en la URL.';
            }

            // Setup navigation
            window.addEventListener('scroll', updateActiveNav);
            
            document.querySelectorAll('header nav ul li a').forEach(link => {
                link.addEventListener('click', function(e) {
                    document.querySelectorAll('header nav ul li a').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
    </script>

    <style>
        .loading-state, .error-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
            text-align: center;
        }

        .loading-state p, .error-state p {
            font-size: 1.2em;
            color: #666;
        }

        .error-content {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .error-content h2 {
            color: #dc3545;
            margin-bottom: 1rem;
        }

        .error-actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</Layout>
